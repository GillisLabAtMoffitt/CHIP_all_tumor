---
title: "R01 data cleaning"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
```

```{r library}
library(tidyverse)
theme_set(theme_classic())
```

```{r load}
path <- fs::path("", "Volumes", "Lab_Gillis","ORIEN_Avatar", "resources")

clinical_mol_linkage <-
  read.csv(paste0(path, "/23PRJ127MCC_NormalizedFiles/23PRJ127MCC_20230620_ClinicalMolLinkage_V4.csv"), na.strings = "")


filenames <- list.files(path = paste0(path, "/23PRJ127MCC_NormalizedFiles"),
                        pattern = "23PRJ127MCC_20230620_.*.csv")
names <- str_match(filenames, "23PRJ127MCC_20230620_(.*)_V4.csv")[,2]

for(i in names){
    filepath <- file.path(paste0(path, "/23PRJ127MCC_NormalizedFiles/",paste("23PRJ127MCC_20230620_", i, "_V4.csv",sep="")))
    assign(i, read.csv(filepath, na.strings = ""))
}

rm(filenames, names, filepath, i)
```

```{r cytogenetics cleaning}
CytogeneticAbnormalities <- CytogeneticAbnormalities %>% 
  filter(CytogenAbnormResult == "Positive")

CytogeneticAbnormalities <-
  CytogeneticAbnormalities %>% 
  select(AvatarKey, CytogenAbnormName, CytogenAbnormInd) %>% 
  distinct() %>% 
  # group_by(AvatarKey, hormone_therapy_start_date) %>%
  pivot_wider(id_cols = c(AvatarKey),
    names_from = CytogenAbnormName,
              values_from = CytogenAbnormInd)
```

For demographics data, I made a really quick cleaning.    
- White vs Black vs Others    
- Hispanic vs Non-Hispanic ("Spanish surname only" is considered as Unknown)    
```{r demo cleaning}
table(PatientMaster$Race)
table(PatientMaster$Ethnicity)

demographics <- PatientMaster %>% 
  mutate(Race = case_when(
    Race == "White"                            ~ "White",
    Race == "Black"                            ~ "Black",
    str_detect(Race, "Unknown")                ~ "Unknown",
    TRUE                                       ~ "Others"
  )) %>% 
  mutate(Ethnicity = case_when(
    Ethnicity == "Spanish surname only"        ~ "Unknown",
    str_detect(Ethnicity, "Non-Hispanic")      ~ "Non-Hispanic",
    str_detect(Ethnicity, "Unknown")           ~ "Unknown",
    TRUE                                       ~ "Hispanic"
  )) %>% 
  mutate(race_eth = case_when(
    Race == "White" &
      Ethnicity == "Non-Hispanic"              ~ "White Non-Hispanic",
    Race == "Black" &
      Ethnicity == "Non-Hispanic"              ~ "Black",
    Race == "Others" &
      Ethnicity == "Non-Hispanic"              ~ "Others Non-Hispanic",
    Ethnicity == "Hispanic"                    ~ "Hispanic"
  ))

rm(PatientMaster)
```

Diagnosis :
- Do we want to include only patients who are seen for a primary diagnosis?   
- I only included the first diagnosis
```{r}
Diagnosis <- Diagnosis %>% 
  select(AvatarKey, AgeAtDiagnosis, YearOfDiagnosis,
         PrimaryDiagnosisSiteCode : Histology,
         ClinGroupStage,
         CurrentlySeenForPrimaryOrRecurr,
         PerformStatusAtDiagnosis) %>% 
  mutate(ECOG = str_match(PerformStatusAtDiagnosis, "ECOG ([:digit:])")[,2]) %>% 
  mutate(Karnofsky = str_match(PerformStatusAtDiagnosis, "Karnofsky ([:digit:].*)%")[,2]) %>% 
  arrange(AvatarKey, AgeAtDiagnosis) %>% 
  group_by(AvatarKey) %>% 
  mutate(diagnosis_sequence = row_number(AvatarKey), .after = AvatarKey) %>% 
  mutate(has_subsequent_cancer = case_when(
    diagnosis_sequence > 1           ~ "Yes"
  )) %>% 
  fill(has_subsequent_cancer, .direction = "updown") %>% 
  ungroup() %>% 
  distinct(AvatarKey, .keep_all = TRUE)
  
# Diagnosis_wide <- dcast(setDT(Diagnosis_), AvatarKey + has_subsequent_cancer ~ rowid(AvatarKey), 
#       value.var = c("Medication")) 
```

```{r}

```












